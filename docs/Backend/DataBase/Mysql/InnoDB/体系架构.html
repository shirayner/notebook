<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Backend/DataBase/Mysql/InnoDB/体系架构">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Mysql与InnoDB体系架构 | Ray</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shirayner.github.io/notebook/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://shirayner.github.io/notebook/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://shirayner.github.io/notebook/docs/Backend/DataBase/Mysql/InnoDB/体系架构"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Mysql与InnoDB体系架构 | Ray"><meta data-rh="true" name="description" content="[toc]"><meta data-rh="true" property="og:description" content="[toc]"><link data-rh="true" rel="icon" href="/notebook/img/logo2.svg"><link data-rh="true" rel="canonical" href="https://shirayner.github.io/notebook/docs/Backend/DataBase/Mysql/InnoDB/体系架构"><link data-rh="true" rel="alternate" href="https://shirayner.github.io/notebook/docs/Backend/DataBase/Mysql/InnoDB/体系架构" hreflang="zh"><link data-rh="true" rel="alternate" href="https://shirayner.github.io/notebook/docs/Backend/DataBase/Mysql/InnoDB/体系架构" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/notebook/blog/rss.xml" title="Ray RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notebook/blog/atom.xml" title="Ray Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/notebook/assets/css/styles.4d8ef97f.css">
<link rel="preload" href="/notebook/assets/js/runtime~main.d5824e76.js" as="script">
<link rel="preload" href="/notebook/assets/js/main.6e07321e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notebook/"><div class="navbar__logo"><img src="/notebook/img/logo2.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/notebook/img/logo2.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Ray</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">后端</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/notebook/docs/category/Java">Java</a></li><li><a class="dropdown__link" href="/notebook/docs/category/数据库">数据库</a></li><li><a class="dropdown__link" href="/notebook/docs/category/Git">Git</a></li></ul></div><a class="navbar__item navbar__link" href="/notebook/docs/category/操作系统">操作系统</a><a class="navbar__item navbar__link" href="/notebook/docs/FrontEnd/index">前端</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/notebook/docs/Inbox">Inbox</a><a class="navbar__item navbar__link" href="/notebook/docs/tags">Tags</a><a href="https://github.com/shirayner" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notebook/docs/Backend/index">Backend</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notebook/docs/category/java">Java</a><button aria-label="打开/收起侧边栏菜单「Java」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/notebook/docs/category/数据库">数据库</a><button aria-label="打开/收起侧边栏菜单「数据库」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/notebook/docs/category/mysql">Mysql</a><button aria-label="打开/收起侧边栏菜单「Mysql」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/资源帖">资源帖</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notebook/docs/category/mysql基础">Mysql基础</a><button aria-label="打开/收起侧边栏菜单「Mysql基础」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/notebook/docs/category/innodb">InnoDB</a><button aria-label="打开/收起侧边栏菜单「InnoDB」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/资源帖">资源帖</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/体系架构">体系架构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/逻辑存储与物理存储">逻辑存储与物理存储</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/日志体系">日志体系</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/事务原理与锁机制">事务原理与锁机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/DDL底层原理">DDL底层原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/Mysql分库分表">分库分表</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notebook/docs/category/查询优化">查询优化</a><button aria-label="打开/收起侧边栏菜单「查询优化」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notebook/docs/category/生产排障">生产排障</a><button aria-label="打开/收起侧边栏菜单「生产排障」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notebook/docs/Backend/DataBase/数据存储入门概览">数据存储入门概览</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notebook/docs/category/ddd">DDD</a><button aria-label="打开/收起侧边栏菜单「DDD」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notebook/docs/category/architecture">Architecture</a><button aria-label="打开/收起侧边栏菜单「Architecture」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notebook/docs/category/git">Git</a><button aria-label="打开/收起侧边栏菜单「Git」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/notebook/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notebook/docs/category/数据库"><span itemprop="name">数据库</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notebook/docs/category/mysql"><span itemprop="name">Mysql</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notebook/docs/category/innodb"><span itemprop="name">InnoDB</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">体系架构</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Mysql与InnoDB体系架构</h1><p>[toc]</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="推荐阅读">推荐阅读<a href="#推荐阅读" class="hash-link" aria-label="推荐阅读的直接链接" title="推荐阅读的直接链接">​</a></h2><p>文章：</p><blockquote><ul><li><a href="https://blog.csdn.net/hguisu/article/details/7106342" target="_blank" rel="noopener noreferrer">MySQL架构原理(详解)</a></li><li><a href="https://www.51cto.com/article/648245.html" target="_blank" rel="noopener noreferrer">8张图，5大组件！了解MySQL查询语句执行过程</a></li><li><a href="https://www.cnblogs.com/mengxinJ/p/14045520.html" target="_blank" rel="noopener noreferrer">一条 sql 的执行过程详解</a></li><li><a href="https://zhuanlan.zhihu.com/p/142491549" target="_blank" rel="noopener noreferrer">MySQL 的 crash-safe 原理解析</a></li></ul></blockquote><p>流程图：</p><blockquote><ul><li><a href="https://www.processon.com/view/625ed5d607912907047b8c74?fromnew=1" target="_blank" rel="noopener noreferrer">MYSQL底层剖析</a></li><li><a href="https://www.processon.com/view/5f3cdb807d9c0806d4216ad0?fromnew=1" target="_blank" rel="noopener noreferrer">Mysql体系结构、innodb、redolog、事务、双写等Mysql 体系结构、innodb、redolog、事务、双写等</a></li><li><a href="https://www.processon.com/view/5f1998bbe0b34d54dac69f4a?fromnew=1" target="_blank" rel="noopener noreferrer">MySQL底层执行原理</a></li></ul></blockquote><p>存储引擎对比：</p><blockquote><ul><li><a href="https://www.cnblogs.com/pengpengdeyuan/p/15001739.html" target="_blank" rel="noopener noreferrer">mysql学习--MySQL存储引擎对比总结</a></li></ul></blockquote><p>InnoDB数据存储结构</p><blockquote><ul><li><a href="https://juejin.cn/post/6968264298208428046" target="_blank" rel="noopener noreferrer">MySQL系列（2）— InnoDB数据存储结构</a></li></ul></blockquote><p>Mysql日志：</p><blockquote><ul><li><a href="https://juejin.cn/post/6987557227074846733" target="_blank" rel="noopener noreferrer">彻底搞懂MySQL的redo log，binlog，undo log</a></li><li><a href="http://mysql.taobao.org/monthly/2021/10/01/" target="_blank" rel="noopener noreferrer">MySQL · 引擎特性 · 庖丁解InnoDB之UNDO LOG</a></li><li><a href="https://segmentfault.com/a/1190000014810628" target="_blank" rel="noopener noreferrer">MySQL 2PC <!-- -->&amp;<!-- --> Group Commit</a></li><li><a href="https://blog.csdn.net/Singularinty/article/details/80747290" target="_blank" rel="noopener noreferrer">数据库中常说的steal和force到底是什么</a></li><li><a href="https://www.zhihu.com/question/377360399" target="_blank" rel="noopener noreferrer">数据库的读取问题in steal/no force?</a></li><li><a href="https://cloud.tencent.com/developer/article/1905278" target="_blank" rel="noopener noreferrer">undo log为什么需要持久化？</a></li></ul></blockquote><p>SQL 解析：</p><blockquote><ul><li><a href="https://tech.meituan.com/2018/05/20/sql-parser-used-in-mtdp.html" target="_blank" rel="noopener noreferrer">SQL解析在美团的应用</a></li><li><a href="https://www.cnblogs.com/smartloli/p/15857369.html" target="_blank" rel="noopener noreferrer">SQL解析器详解</a></li><li><a href="https://www.jiqizhixin.com/articles/2018-12-12-17" target="_blank" rel="noopener noreferrer">MySQL内核源码解读-SQL解析之解析器浅析</a></li></ul></blockquote><p>SQL 优化：</p><blockquote><ul><li><a href="https://developer.aliyun.com/article/679873" target="_blank" rel="noopener noreferrer">深入解析：从源码窥探MySQL优化器</a></li><li><a href="http://mysql.taobao.org/monthly/2020/10/01/" target="_blank" rel="noopener noreferrer">MySQL · 源码分析 · 子查询优化源码分析</a></li><li><a href="https://juejin.cn/post/6954708924738043911" target="_blank" rel="noopener noreferrer">MySQL 查询优化（四）：深入了解 MySQL查询优化处理过程</a></li><li><a href="https://zhuanlan.zhihu.com/p/56790651" target="_blank" rel="noopener noreferrer">[玩转MySQL之六]MySQL查询优化器</a></li><li><a href="https://cloud.tencent.com/developer/article/1678069" target="_blank" rel="noopener noreferrer">98%的人不知道的MySQL优化器原理</a></li></ul></blockquote><p>InnoDB三大特性：</p><blockquote><ul><li><a href="https://www.cnblogs.com/chenpingzhao/p/4883884.html" target="_blank" rel="noopener noreferrer">【mysql】Innodb三大特性之insert buffer</a></li><li><a href="https://www.cnblogs.com/ZhuChangwu/p/14683528.html" target="_blank" rel="noopener noreferrer">全网最清楚的：MySQL的insert buffer和change buffer 串讲</a></li><li><a href="https://cheng-dp.github.io/2019/05/05/innodb-three-feature/" target="_blank" rel="noopener noreferrer">InnoDB三大特性(DoubleWrite, InsertBuffer, Adaptive Hash Index</a></li></ul></blockquote><p>MVCC：</p><blockquote><ul><li><a href="http://mysql.taobao.org/monthly/2018/03/01/" target="_blank" rel="noopener noreferrer">MySQL · 源码分析 · InnoDB的read view，回滚段和purge过程简介</a></li><li><a href="https://blog.csdn.net/qq_42651904/article/details/110622818" target="_blank" rel="noopener noreferrer">从ReadView深入理解MySql MVCC原理</a></li><li><a href="https://www.helloworld.net/p/3668975309" target="_blank" rel="noopener noreferrer">【MySQL笔记】正确的理解MySQL的MVCC及实现原理</a></li><li><a href="https://zhuanlan.zhihu.com/p/40208895" target="_blank" rel="noopener noreferrer">MySQL InnoDB MVCC实现</a></li><li><a href="http://mysql.taobao.org/monthly/2017/12/01/" target="_blank" rel="noopener noreferrer">MySQL · 引擎特性 · InnoDB 事务系统</a></li></ul></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一mysql体系结构">一、Mysql体系结构<a href="#一mysql体系结构" class="hash-link" aria-label="一、Mysql体系结构的直接链接" title="一、Mysql体系结构的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-数据库与实例">1.1 数据库与实例<a href="#11-数据库与实例" class="hash-link" aria-label="1.1 数据库与实例的直接链接" title="1.1 数据库与实例的直接链接">​</a></h3><ul><li><p>数据库：</p><blockquote><p>数据库是文件的集合，这些文件可能存在于内存中或磁盘上。</p></blockquote></li><li><p>数据库实例</p><blockquote><p>数据库实例是程序，用户通过数据库实例来操作数据库数据。数据库实例是位于用户和操作系统之间的一层数据管理软件，用户对数据库数据的任何操作，包括数据库定义、数据查询、数据维护等都是在数据库实例下进行的。</p><p>Mysql数据库实例由后台线程以及一个共享内存区组成。</p></blockquote></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-mysql体系结构">1.2 Mysql体系结构<a href="#12-mysql体系结构" class="hash-link" aria-label="1.2 Mysql体系结构的直接链接" title="1.2 Mysql体系结构的直接链接">​</a></h3><p>Mysql 整体的体系结构大致可分为：连接层、核心服务层、存储引擎层、数据存储层。</p><p><img loading="lazy" src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWctbXkuY3Nkbi5uZXQvdXBsb2Fkcy8yMDEyMTEvMTUvMTM1Mjk1OTg0N185MTQ3LmpwZw?x-oss-process=image/format,png" class="img_ev3q"></p><p>更详细的结构如下：</p><p><img loading="lazy" alt="20150514224849922" src="/notebook/assets/images/20150514224849922-cc6d43de69466b4dc3e088a2e87cd256.png" width="632" height="418" class="img_ev3q"></p><p>MySQL的架构自顶向下大致可以分为客户端连接层、数据库服务层、存储引擎层和系统文件层四大部分：</p><p>(1) 客户端连接层</p><p>提供Mysql客户端与服务端建立连接的能力，几乎提供了所有主流服务端语言的SDK。</p><p>(2) 数据库服务层</p><p>数据库服务层是整个数据库服务器的核心，主要包含了以下组件</p><blockquote><ul><li>管理服务和工具</li><li>连接池</li><li>SQL接口</li><li>解析器</li><li>查询优化器</li><li>缓存与缓冲</li></ul></blockquote><p>管理服务和工具：</p><blockquote><p>提供对数据库服务的管理能力，例如提供数据备份与恢复、安全管理、复制、集群、配置、迁移等能力</p></blockquote><p>连接池：</p><blockquote><p>主要负责存储和管理客户端与数据库的连接信息，连接池里的一个线程负责管理一个客户端到数据库的连接信息</p></blockquote><p>SQL接口：</p><blockquote><p>主要负责接收客户端发送过来的各种SQL命令，并将SQL命令发送到其他部分，并接收其他部分返回的结果数据，将结果数据返回给客户端。</p></blockquote><p>解析器：</p><blockquote><p>负责将请求的SQL解析生成一个&quot;解析树&quot;。然后根据一些MySQL规则进一步检查解析树是否合法。</p></blockquote><p>查询优化器：</p><blockquote><p>在MySQL中，如果“解析树”通过了解析器的语法检查，此时就会由优化器将其转化为执行计划，然后与存储引擎进行交互，通过存储引擎与底层的数据文件进行交互。</p></blockquote><p>缓存与缓冲:</p><blockquote><p>如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等。主要功能是将客户端提交 给MySQL 的 Select 类 query 请求的返回结果集 cache 到内存中，与该 query 的一个 hash 值 做一个对应。该 Query 所取数据的基表发生任何数据的变化之后， MySQL 会自动使该 query 的Cache 失效。在读写比例非常高的应用系统中， Query Cache 对性能的提高是非常显著的。当然它对内存的消耗也是非常大的。</p></blockquote><p>（3）存储引擎层</p><blockquote><p>提供内存、索引、存储管理，负责数据的写入和读取，与底层的文件进行交互。MySQL中的存储引擎是插件式的，服务器中的查询执行引擎通过相关的接口与存储引擎进行通信，同时，接口屏蔽了不同存储引擎之间的差异。</p></blockquote><p>（4）系统文件层</p><p>系统文件层主要包括MySQL中存储数据的底层文件，与上层的存储引擎进行交互，是文件的物理存储层。其存储的文件主要有：pid文件、套接字文件、日志文件、数据文件、配置文件等。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-mysql存储引擎对比">1.3 Mysql存储引擎对比<a href="#13-mysql存储引擎对比" class="hash-link" aria-label="1.3 Mysql存储引擎对比的直接链接" title="1.3 Mysql存储引擎对比的直接链接">​</a></h3><p>通过 <code>show engines</code> 命令可以查看 mysql 提供了哪些引擎：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> engines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token comment" style="color:#999988;font-style:italic">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Engine</span><span class="token plain">             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Support </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Comment</span><span class="token plain">                                                        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Transactions</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> XA   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Savepoints </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token comment" style="color:#999988;font-style:italic">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain">             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Supports </span><span class="token keyword" style="color:#00009f">transactions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">level</span><span class="token plain"> locking</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">keys</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MRG_MYISAM         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Collection </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> identical MyISAM </span><span class="token keyword" style="color:#00009f">tables</span><span class="token plain">                          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MEMORY             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Hash</span><span class="token plain"> based</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stored </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> memory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useful </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">temporary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">tables</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BLACKHOLE          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">/</span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> storage </span><span class="token keyword" style="color:#00009f">engine</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">anything you </span><span class="token keyword" style="color:#00009f">write</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> it disappears</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MyISAM             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MyISAM storage </span><span class="token keyword" style="color:#00009f">engine</span><span class="token plain">                                          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CSV                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CSV storage </span><span class="token keyword" style="color:#00009f">engine</span><span class="token plain">                                             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ARCHIVE            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Archive storage </span><span class="token keyword" style="color:#00009f">engine</span><span class="token plain">                                         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PERFORMANCE_SCHEMA </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> YES     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Performance </span><span class="token keyword" style="color:#00009f">Schema</span><span class="token plain">                                             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FEDERATED          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Federated MySQL storage </span><span class="token keyword" style="color:#00009f">engine</span><span class="token plain">                                 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token comment" style="color:#999988;font-style:italic">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">rows</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.00</span><span class="token plain"> sec</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>每个储存引擎支持的功能如下表所示：</p><p><img loading="lazy" alt="img" src="/notebook/assets/images/1858147-20210712150314492-444733776-f1047aab6d15b82b967d30e82270c55b.png" width="976" height="831" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二sql语句执行过程">二、SQL语句执行过程<a href="#二sql语句执行过程" class="hash-link" aria-label="二、SQL语句执行过程的直接链接" title="二、SQL语句执行过程的直接链接">​</a></h2><h4 class="anchor anchorWithStickyNavbar_LWe7" id="31-查询语句执行过程">3.1 查询语句执行过程<a href="#31-查询语句执行过程" class="hash-link" aria-label="3.1 查询语句执行过程的直接链接" title="3.1 查询语句执行过程的直接链接">​</a></h4><p><img loading="lazy" alt="1665373287193" src="/notebook/assets/images/1665373287193-280645753dfa8307e8a1f1c7429037d8.png" width="395" height="678" class="img_ev3q"></p><p>MySQL 整个查询执行过程，总的来说分为 6 个步骤 :</p><blockquote><p>SQL执行步骤：请求、缓存、SQL解析、优化SQL查询、调用引擎执行，返回结果
1、连接：客户端与服务端端建立连接，并向服务端发送查询请求，这里涉及到连接池、认证等相关处理。
2、缓存：服务器首先检查查询缓存，如果命中缓存，则立刻返回存储在缓存中的结果，否则进入下一阶段。Mysql 8.0 移除此功能。
3、解析：解析SQL语句(词法分析、语法分析、预处理)，生成SQL语法树。
4、优化：优化器会生成相应的执行计划，比如使用哪个索引，或者选择表的连接顺序。
5、执行：执行器根据执行计划，调用存储引擎API去执行查询。
6、结果：将结果返回给客户端，同时缓存查询结果。</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="32-更新语句执行过程">3.2 更新语句执行过程<a href="#32-更新语句执行过程" class="hash-link" aria-label="3.2 更新语句执行过程的直接链接" title="3.2 更新语句执行过程的直接链接">​</a></h4><p>以最常用的Innodb为例，首先假设我们有一条SQL语句：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;xxx&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行更新语句的过程大体上与查询相同，如下图所示：</p><p><img loading="lazy" src="https://file+.vscode-resource.vscode-cdn.net/d%3A/Users/r.shi/doc/snote/docs/cs/backend/db/sql_mysql/mysql-advance/images/01_Mysql%E4%B8%8EInnoDB%E7%9A%84%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/1665395507890.png" alt="1665395507890" class="img_ev3q"></p><p>执行器会根据执行计划，调用存储引擎API去完成磁盘和内存层面的数据更新操作，会经历如下八个步骤：</p><blockquote><ol><li>从磁盘中读取数据，并写入缓冲池</li><li>将旧值写入Undo日志文件，以便回滚</li><li>更新内存数据</li><li>写Redo日志到Redo日志缓冲</li><li>Rdeo日志缓冲数据刷入磁盘</li><li>Binlog日志写入磁盘</li><li>Redo日志文件中写入Binlog文件名和位置以及Commit标记</li><li>后台IO线程将缓冲区中的数据刷入磁盘</li></ol></blockquote><p>这八个步骤中，前七个步骤都是由执行器来完成的。</p><p>（1）从磁盘中读取数据，并写入缓冲池</p><p>InnoDB存储引擎内存中有一个非常重要组件，就是缓冲池（Buffer Pool），用于缓存一些磁盘数据。这样，当查询命中缓存时，就无需再去读磁盘了。</p><p><img loading="lazy" alt="1665374550858" src="data:image/png;base64,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" width="232" height="231" class="img_ev3q"></p><p>InnoDB执行更新语句的时候，比如对 <code>id=10</code> 这一行数据，它首先会看 <code>id=10</code> 这一行数据是否在缓冲池中，如果不在的话，那么会直接从磁盘里加载数据到缓冲池里来，而且还会对这行记录加独占锁。</p><p>（2）将旧值写入Undo日志文件，以便回滚</p><p>undo 存放在undo段（undo segment） 中，undo 段位于共享表空间。</p><p>undo log有两个最主要的作用：多版本并发控制（MVCC） 和 故障恢复。</p><p>MVCC：在InnoDB存储引擎中MVCC的实现是通过 undo 日志来完成的。当用户读取一行记录时，若该记录已经别其他事务占用，当前事务可以通过undo读取之前的行版本信息，以此实现非锁定读。</p><p>故障恢复：</p><ul><li>由于Undo log中记录了上一个版本的数据，因此如果用户执行的事务或语句由于某种原因失败了，又或者用户用一条ROLLBACK语句请求回滚，就可以利用这些信息将数据回滚到修改之前的样子。</li><li>undo 是逻辑日志，因此只是将数据库逻辑地恢复到原来的样子。所有修改都被逻辑地取消了，但是数据结构和页本身在回滚之后可能大不相同。数据库的主要任务就是协调对数据记录的并发访问。比如，一个事务在修改前一个页中某几条记录，同时还有别的事务在对同一个页中另外几条记录进行修改。因此，不能讲一个页回滚到事务开始的样子，因为这样会影响其他事务正在进行的工作。</li><li>用户执行ROLLBACK时，会将插入的事务进行回滚，但是表空间的大小并不会因此而收缩。</li><li>回滚执行的是逆向操作：每当InnoDB中需要修改某个Record时，都会将其历史版本写入一个Undo Log中，这种Undo Record是Update类型。当插入新的Record时，还没有一个历史版本，但为了方便事务回滚时做逆向（Delete）操作，这里还是会写入一个Insert类型的Undo Record。对于每个Insert ，InnoDB会执行一个Delete。对于每个Update，InnoDB会执行一个相反的Update.</li></ul><p>Undo log 会产生 redo log，也就是 undo log 的产生会伴随着 redo log 的产生，这是因为 undo log 也需要持久性的保护。</p><p>Undo Log 用于保证事务的一致性。</p><p>（3）更新 Buffer pool 中的缓存数据</p><p>当我们把要更新的那行记录从磁盘文件加载到缓冲池，同时对他加锁之后，而且还把更新前的旧值写入undo日志文件。
之后，我们就可以正式开始更新这行记录了，更新的时候，先是会更新缓冲池中的记录，此时这个数据就是脏数据
了。这里所谓的更新内存缓冲池里的数据，意思就是把内存里的“id=10”这行数据的name字段修改为“xxx”。</p><p>（4）写 Redo Log Buffer</p><p>当缓冲池中的数据完成修改之后，需要将内存中的数据刷新到磁盘，但是在刷新前，会先把本次对内存所做的修改写入到一个 Redo Log Buffer 里去，这也是内存里的一个缓冲区，是用来存放Redo日志。</p><p>所谓的redo日志，就是记录下来你对数据做了什么修改，比如对“id=10这行记录修改了name字段的值为xxx”，这就是一个日志。到这一步的时候，Mysql如果宕机了，是不会有问题的。</p><p>redo log 和 undo log：</p><ul><li>redo 和 undo 的作用都可以视为一种恢复操作，一个向前，一个向后。 redo恢复提交事务修改的页操作，而undo 回滚行记录到某个特定版本。因此两者记录的内容不同，redo 通常是物理日志，记录的是页的物理修改操作。undo是逻辑日志，根据每行记录进行记录。</li><li>redo log 用来保证事务的持久性，undo log 用来帮助事务回滚及MVCC的功能。</li><li>redo log 基本都是顺序写的，在数据库运行时不需要对redo log文件进行读取操作。而undo log 是需要进行随机读写的。</li></ul><p>InnoDB 通过 Force Log at Commit 机制实现事务的持久性，即当事务提交时，必须先将该事务的所有日志写入到 重做日志文件进行持久化，待事务的Commit 操作完成才算完成。</p><p>在每次将重做日志缓冲写入重做日志文件后，InnoDB存储引擎都需要调用一次 fsync 操作。</p><blockquote><p>fsync 是 Unix系统的一个系统调用，能确保写磁盘操作结束后才返回。</p></blockquote><p>（6）提交事务的时候，将redo日志写入磁盘</p><p>接着我们想要提交一个事务了，此时就会根据一定的策略把redo日志从redo log buffer里刷入到磁盘文件里去。</p><p>此时这个策略是通过 innodb_flush_log_at_trx_commit 来控制的，可取以下值，默认为1：</p><blockquote><ul><li>0：事务提交时，redo log不刷盘。刷盘仅在 master thread 中完成，而master thread 中每1秒会进行一次Redo日志文件的fsync操作。采用此策略，会存在事务已提交，但数据丢失的情况。比如事务提交成功后，Mysql宕机，内存中数据和redo日志丢失。</li><li>1：事务提交时，必须调用一次 fsync操作。采用此策略，只要提交事务成功，redo log 就必然在磁盘里。此时，事务提交成功后，就算宕机，Mysql也能根据redo  log 重新恢复数据，可以严格保证数据不丢失。</li><li>2：提交事务时，redo log写入磁盘文件对应 os cache 缓存中去，而不进行fsync，可能1秒后才会把 os cache里的数据写入到磁盘文件里去（sync）。采用此策略，在提交事务后，redo log可能仅仅停留在os cache内存缓存里，没实际写入磁盘文件，此时，如果Mysql宕机而操作系统没宕机，则并不会导致事务丢失。而如果操作系统宕机了，那么os cache里的redo log就会丢失，从而导致事务丢失。</li></ul></blockquote><p>一般建议 redo 日志刷盘策略设置为1，保证事务提交之后，数据不丢失。</p><p>（7）binlog日志写入磁盘</p><p>在Mysql数据库中还有一种二进制日志 binlog，其用来进行 point-in-time-recovery（时间点恢复，是指恢复到给定时间点的数据更改） 及主从复制（Replication）环境的建立。</p><p>binlog是Mysql 自己的日志文件，他里面记录的是偏向于逻辑性的日志，类似于“对users表中的id=10的一行数据做了更新操作，更新以后的值是什么”</p><p>Redo log 和 Binlog：</p><ul><li>层面不同：Redo log 是InnoDB存储引擎上的日志，而 Binlog 是在Mysql 数据库上层产生的，任务存储引擎都会产生Binlog。</li><li>内容形式不同：Binlog 是一种逻辑日志，其记录的是对应的SQL语句。而Redo log 是物理格式的日志，其记录的是对于每个页的修改。</li><li>刷盘时机不同：Binlog 只在事务提交完成后，进行一次写入。而Redo log 在事务进行中不断地被写入，这表现为日志并不是随事务提交的顺序进行写入的。</li></ul><p>对于 Binlog 日志，有一个参数 sync_binlog 可以控制BInlog的刷盘策略，取值如下，默认为0：</p><blockquote><ul><li>0：不直接写入磁盘文件，而是写入到 os cache 内存缓存。</li><li>1：先把binlog 写入到磁盘文件，再提交事务。</li></ul></blockquote><p>（8）基于Binlog 和 Redo log 完成事务的提交</p><p>当我们把binlog写入磁盘文件之后，接着就会完成最终的事务提交，此时会把本次更新对应的binlog文件名称和这次
更新的binlog日志在文件里的位置，都写入到redo log日志文件里去，同时在redo log日志文件里写入一个commit标记，在完成这个事情之后，才算最终完成了事务的提交。</p><p>Mysql 两阶段提交引出：</p><blockquote><p>当MySQL开启binlog的时候，会存在一个内部XA的问题：事务在存储引擎层（redo）commit的顺序和在binlog中提交的顺序不一致的问题。如果不使用两阶段提交，那么数据库的状态有可能用它的日志恢复出来的库的状态不一致。</p></blockquote><p>Mysql的两阶段提交：</p><blockquote><p>1.prepare阶段：redo持久化到磁盘（redo group commit），并将回滚段置为 prepared 状态，此时binlog 不做操作。</p><p><img loading="lazy" src="https://file+.vscode-resource.vscode-cdn.net/d%3A/Users/r.shi/doc/snote/docs/cs/backend/db/sql_mysql/mysql-advance/images/01_Mysql%E4%B8%8EInnoDB%E7%9A%84%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/1665420187115.png" alt="1665420187115" class="img_ev3q"></p><p>2.commit阶段：innodb释放锁，释放回滚段，设置提交状态，binlog持久化到磁盘，然后存储引擎层提交</p><p><img loading="lazy" alt="1665420222499" src="/notebook/assets/images/1665420222499-c0ac3797f8497e192c1e2c421921b05d.png" width="732" height="437" class="img_ev3q"></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三innodb体系结构">三、InnoDB体系结构<a href="#三innodb体系结构" class="hash-link" aria-label="三、InnoDB体系结构的直接链接" title="三、InnoDB体系结构的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-体系结构概览">1. 体系结构概览<a href="#1-体系结构概览" class="hash-link" aria-label="1. 体系结构概览的直接链接" title="1. 体系结构概览的直接链接">​</a></h3><p><img loading="lazy" alt="1570550700057" src="/notebook/assets/images/1570550700057-ad15d6e5cddea906f9178638893c41ca.png" width="566" height="370" class="img_ev3q"></p><p> InnoDB 存储引擎体系结构，可分为如下三个部分：</p><p>（1）内存池</p><blockquote><p>InnoDB存储引擎有多个内存块，可以认为这些内存块组成了一个大的内存池，负责如下工作：</p><ul><li>维护所有进程/线程需要访问的内部数据结构</li><li>缓存磁盘上的数据</li><li>重做日志（redo log）缓冲</li><li>......</li></ul></blockquote><p>（2）后台线程</p><blockquote><ul><li>主要负责刷新内存池中的数据，保证内存池缓存的数据是最新的</li><li>此外，将已修改的数据文件刷新到磁盘文件</li><li>同时，保证在数据库发生异常的情况下InnoDB能恢复到正常运行状态</li></ul></blockquote><p>（3）文件</p><p>InnoDB会将相关数据持久化到这些磁盘文件中</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-体系结构图">2. 体系结构图<a href="#2-体系结构图" class="hash-link" aria-label="2. 体系结构图的直接链接" title="2. 体系结构图的直接链接">​</a></h3><p>在InnoDB的体系结构中涉及的内存区域和磁盘文件如下图所示</p><p><img loading="lazy" alt="1665478098024" src="/notebook/assets/images/1665478098024-d2d70cb2e6b27b7ec363bde2cd1d302e.png" width="885" height="680" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-内存池">3. 内存池<a href="#3-内存池" class="hash-link" aria-label="3. 内存池的直接链接" title="3. 内存池的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="31-缓冲池">3.1 缓冲池<a href="#31-缓冲池" class="hash-link" aria-label="3.1 缓冲池的直接链接" title="3.1 缓冲池的直接链接">​</a></h4><p>（1）内存中可以有多个缓冲池实例，每个页根据哈希值平均分配到不同缓冲池实例中。（2）缓冲池中索引页和数据页占了很大一部分。
（3）缓冲池是通过 LRU 算法来进行管理的，即最频繁使用的页在LRU列表的前端，而最少使用的页LRU列表的尾端。当缓冲池不能存放新读取到的页时，将首先释放LRU列表中的尾端的页。</p><p>（4）在InnoDB中，缓冲池中的页大小默认为16KB。同样使用LRU算法，不过加入了 midpoint insertion strategy。</p><p>（5）LUR列表中的页被修改后，称该页为脏页，即缓冲池中的页和磁盘上的页的数据产生了不一致。这时，数据库会通过CheckPoint机制将脏页刷新回磁盘。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="32-redo-log-buffer">3.2 Redo Log Buffer<a href="#32-redo-log-buffer" class="hash-link" aria-label="3.2 Redo Log Buffer的直接链接" title="3.2 Redo Log Buffer的直接链接">​</a></h4><p>（1）InnoDB存储引擎首先将重做日志信息先放入到这个缓冲区，然后分情况将其刷新到重做日志文件：</p><ul><li>Master Thread 每一秒，会将Redo log buffer 刷盘</li><li>每个事务提交时，会将Redo log buffer 刷盘</li><li>当 Redo log buffer 剩余空间小于 1/2 时，会将Redo log buffer 刷盘</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="33-额外的内存池">3.3 额外的内存池<a href="#33-额外的内存池" class="hash-link" aria-label="3.3 额外的内存池的直接链接" title="3.3 额外的内存池的直接链接">​</a></h4><p>对于一些数据结构本身的内存进行分配时，需要从额外的内存池中进行申请，当该区域的内存不够时，会从缓冲池中进行申请。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4check-point">4.Check Point<a href="#4check-point" class="hash-link" aria-label="4.Check Point的直接链接" title="4.Check Point的直接链接">​</a></h3><p>(1) Check Point（检查点）技术的目的是解决以下几个问题：</p><ul><li>缩短数据库的恢复时间；</li><li>缓冲池不够用时，将脏页刷新到磁盘；</li><li>重做日志不可用时，刷新脏页；</li></ul><p>基于Check Point 的宕机恢复：只需要对 CheckPoint 之后的Redo log 进行恢复。</p><p>LRU脏页刷盘：当缓冲池不够用时，根据LRU算法会溢出最近最少使用的页，若此页为脏页，那么需要强制执行CheckPoint，将脏页刷盘。</p><p>重做日志不可用：是因为因为重做日志是循环写的，并不是让其无限增大的。而重做日志可以被重用的部分是指这些重做日志已经不再需要了。</p><p>（2）LSN：InnoDB是通过 LSN( Log Sequence Number) 来标记版本的。LSN是8字节的数字。每个页都有 LSN，重做日志中也有LSN，CheckPoint 也有LSN。</p><p>（3）Check Point 所做的事就是将缓冲池中的脏页刷回磁盘。不同之处在于，每次刷新多少页到磁盘，每次从哪里取脏页，以及什么时间触发CheckPoint。InnoDB中有两种CheckPoint：</p><p>Sharp Checkpoint： 在数据库关闭时，将所有的脏页刷回磁盘，这是默认的工作方式。</p><p>Fuzzy Checkpoint：在数据库运行时，只对部分脏页刷盘。</p><p>在InnnoDB中可能会发生如下几种 Fuzzy Checkpoint：</p><ul><li>Master Thread Checkpoint： 差不多以每秒或每十秒的速度从将脏页刷盘</li><li>FLUSH_LRU_LIST Checkpoint：若LRU中没有100个可用空闲页，那么InnoDB会将LRU尾端的页移除，如果这些页是脏页，那么需要进行CheckPoint。5.6 开始，这个检查被放在单独的 Page Clearner 线程中进行。</li><li>Async/Sync Flush Checkpoint</li><li>Dirty Page too much Checkpoint</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5文件">5.文件<a href="#5文件" class="hash-link" aria-label="5.文件的直接链接" title="5.文件的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="51-表空间文件">5.1 表空间文件<a href="#51-表空间文件" class="hash-link" aria-label="5.1 表空间文件的直接链接" title="5.1 表空间文件的直接链接">​</a></h4><p>（1）共享表空间：InnoDB采用将存储的数据按表空间（TableSpace）进行存放的设计。在默认配置下会有一个初始大小为10M，名为 ibdata1 的文件，该文件就是默认的表空间文件，用户可以通过参数 innodb_data_file_path 进行设置。设置好这个参数后，所有基于InnoDB的表的数据都会记录到该共享表空间。</p><p>（2）用户可以通过多个文件组成一个表空间，同时设置文件属性。</p><p>（3）独立表空间：若设置了参数 Innodb_file_per_table，则用户可以将每个基于InnoDB的表产生一个独立表空间（tablename.ibd）。独立表空间仅存储该表的索引、数据、插入缓冲 BitMap等信息。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="52-redo-log">5.2 redo log<a href="#52-redo-log" class="hash-link" aria-label="5.2 redo log的直接链接" title="5.2 redo log的直接链接">​</a></h4><p>（1）redo log 记录了对于InnoDB的事务日志，可用于宕机恢复、MVCC。</p><p>（2）每个InnoDB至少有1个重做日志组（group），每个文件组下至少有2个重做日志文件，如默认的 ib_logfile0 和 ib_logfile1。为了得到更多的可靠性，用户可以设置多个镜像日志组，将不同的文件组放到不同的磁盘上，以此提高重做日志的高可用性。</p><p>三、InnoDB三大特性</p><p>change buffer，其实在之前版本是插入缓冲(insert buffer)，后续版本变成了 change buffer(参考：内幕 2.4.1 章节)。这一块区域就是 Change Buffer。5.5 之前叫 Insert Buffer 插入缓冲，现在也能支持 delete 和 update，最后把 Change Buffer 记录到数据页的操作叫做 merge。</p><p>插入缓冲：对于辅助索引或非唯一索引，InnoDB会使用Insert Buffer，对于插入或更新操作，不是每一次都直接插入到索引页中，而是先判断插入的非聚集索引页是否在缓冲池中，若在，则直接插入；若不在，则先放到一个InsertBuffer 对象中。然后再以一定频率和情况进行Insert Buffer 和辅助索引页子节点的 merge （合并操作），这时通常能将多个插入合并到一个操作中，能大大提高非聚集索引插入的性能。</p><p>DoubleWrite：在应用（apply） redo log时，用户需要一个页的副本，当写入失效时，先通过页的副本来还原该页，再进行重做。</p><h1>参考资料</h1><ol><li><a href="https://blog.csdn.net/da_guo_li/article/details/80280289" target="_blank" rel="noopener noreferrer">【MySQL】漫谈MySQL体系结构</a></li><li><a href="https://blog.csdn.net/qq_40378034/article/details/90758268" target="_blank" rel="noopener noreferrer">MySQL基础架构与日志详解</a></li><li></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notebook/docs/tags/inno-db">InnoDB</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shirayner/notebook/tree/master/docs/03-Backend/02-DataBase/01-Mysql/02-InnoDB/01_体系架构.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/资源帖"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">资源帖</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notebook/docs/Backend/DataBase/Mysql/InnoDB/逻辑存储与物理存储"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">逻辑存储与物理存储</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#推荐阅读" class="table-of-contents__link toc-highlight">推荐阅读</a></li><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#一mysql体系结构" class="table-of-contents__link toc-highlight">一、Mysql体系结构</a><ul><li><a href="#11-数据库与实例" class="table-of-contents__link toc-highlight">1.1 数据库与实例</a></li><li><a href="#12-mysql体系结构" class="table-of-contents__link toc-highlight">1.2 Mysql体系结构</a></li><li><a href="#13-mysql存储引擎对比" class="table-of-contents__link toc-highlight">1.3 Mysql存储引擎对比</a></li></ul></li><li><a href="#二sql语句执行过程" class="table-of-contents__link toc-highlight">二、SQL语句执行过程</a><ul><li><a href="#31-查询语句执行过程" class="table-of-contents__link toc-highlight">3.1 查询语句执行过程</a></li><li><a href="#32-更新语句执行过程" class="table-of-contents__link toc-highlight">3.2 更新语句执行过程</a></li></ul></li><li><a href="#三innodb体系结构" class="table-of-contents__link toc-highlight">三、InnoDB体系结构</a><ul><li><a href="#1-体系结构概览" class="table-of-contents__link toc-highlight">1. 体系结构概览</a></li><li><a href="#2-体系结构图" class="table-of-contents__link toc-highlight">2. 体系结构图</a></li><li><a href="#3-内存池" class="table-of-contents__link toc-highlight">3. 内存池</a><ul><li><a href="#31-缓冲池" class="table-of-contents__link toc-highlight">3.1 缓冲池</a></li><li><a href="#32-redo-log-buffer" class="table-of-contents__link toc-highlight">3.2 Redo Log Buffer</a></li><li><a href="#33-额外的内存池" class="table-of-contents__link toc-highlight">3.3 额外的内存池</a></li></ul></li><li><a href="#4check-point" class="table-of-contents__link toc-highlight">4.Check Point</a></li><li><a href="#5文件" class="table-of-contents__link toc-highlight">5.文件</a><ul><li><a href="#51-表空间文件" class="table-of-contents__link toc-highlight">5.1 表空间文件</a></li><li><a href="#52-redo-log" class="table-of-contents__link toc-highlight">5.2 redo log</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/notebook/docs/about">关于</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/notebook/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Ray, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/notebook/assets/js/runtime~main.d5824e76.js"></script>
<script src="/notebook/assets/js/main.6e07321e.js"></script>
</body>
</html>